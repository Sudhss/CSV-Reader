<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CSV Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        table {
            table-layout: auto;
            word-wrap: break-word;
        }
        .table-container {
            max-height: 60vh;
            overflow: auto;
            margin-bottom: 20px;
        }
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        #fileInfo {
            margin: 15px 0;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-center mb-4">CSV Viewer</h1>

        <div class="card mb-4">
            <div class="card-body">
                <form id="uploadForm" class="mb-3">
                    <div class="input-group">
                        <input type="file" id="csvFile" name="file" accept=".csv" class="form-control" required>
                        <button type="submit" class="btn btn-primary">Upload CSV</button>
                    </div>
                </form>
                <div id="fileInfo"></div>
                <div id="errorMessage" class="alert alert-danger d-none"></div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading data...</p>
        </div>

        <div id="tableSection" class="d-none">
            <div class="table-container card">
                <div class="card-body p-0">
                    <div id="tableContainer"></div>
                </div>
            </div>
            
            <nav aria-label="Table pagination">
                <ul id="pagination" class="pagination">
                    <!-- Pagination will be inserted here by JavaScript -->
                </ul>
            </nav>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFile = null;
        let currentPage = 1;
        let totalPages = 1;
        let rowsPerPage = 10;

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            showLoading(true);
            clearError();
            
            try {
                // Upload file
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to upload file');
                }
                
                // Update UI with file info
                currentFile = data.filename;
                totalPages = data.total_pages;
                rowsPerPage = data.rows_per_page;
                
                document.getElementById('fileInfo').textContent = 
                    `File: ${data.filename} | Rows: ${data.total_rows} | Pages: ${data.total_pages}`;
                
                // Load first page
                currentPage = 1;
                await loadPage(currentPage);
                
                // Show table section
                document.getElementById('tableSection').classList.remove('d-none');
                
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        });
        
        async function loadPage(page) {
            if (!currentFile) return;
            
            showLoading(true);
            clearError();
            
            try {
                const response = await fetch(`/get_data?filename=${encodeURIComponent(currentFile)}&page=${page}&rows_per_page=${rowsPerPage}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load data');
                }
                
                // Update table content
                document.getElementById('tableContainer').innerHTML = data.table_html;
                currentPage = page;
                
                // Update pagination
                updatePagination();
                
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" ${currentPage === 1 ? 'tabindex="-1"' : ''}>Previous</a>`;
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) loadPage(currentPage - 1);
            });
            pagination.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadPage(i);
                });
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" ${currentPage === totalPages ? 'tabindex="-1"' : ''}>Next</a>`;
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) loadPage(currentPage + 1);
            });
            pagination.appendChild(nextLi);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
        }
        
        function clearError() {
            document.getElementById('errorMessage').classList.add('d-none');
        }
    </script>
</body>
</html>
